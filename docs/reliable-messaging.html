<html><head><title>Akka-DDD: Reliable messaging</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Paweł Kaczor" /><meta name="description" content="Scala CQRS/ES framework" /><meta name="og:image" content="/akka-ddd/img/poster.png" /><meta name="og:title" content="Akka-DDD: Reliable messaging" /><meta name="og:site_name" content="Akka-DDD" /><meta name="og:url" content="http://github.com/pawelkaczor/akka-ddd" /><meta name="og:type" content="website" /><meta name="og:description" content="Scala CQRS/ES framework" /><link rel="icon" type="image/png" href="/akka-ddd/img/favicon.png" /><meta name="twitter:title" content="Akka-DDD: Reliable messaging" /><meta name="twitter:image" content="http://github.com/pawelkaczor/akka-dddimg/poster.png" /><meta name="twitter:description" content="Scala CQRS/ES framework" /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="16x16" href="/akka-ddd/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/akka-ddd/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/akka-ddd/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/akka-ddd/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/akka-ddd/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/akka-ddd/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/akka-ddd/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/akka-ddd/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/akka-ddd/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/akka-ddd/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/akka-ddd/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/akka-ddd/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/akka-ddd/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/akka-ddd/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/akka-ddd/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/akka-ddd/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/akka-ddd/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/akka-ddd/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/akka-ddd/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/akka-ddd/img/favicon310x150.png" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/akka-ddd/highlight/styles/github.css" /><link rel="stylesheet" href="/akka-ddd/css/style.css" /><link rel="stylesheet" href="/akka-ddd/css/palette.css" /><link rel="stylesheet" href="/akka-ddd/css/codemirror.css" /><link rel="stylesheet" href="/akka-ddd/css/override.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><ul id="sidebar" class="sidebar-nav"><li class="sidebar-brand"><a href="/akka-ddd/" class="brand"><div class="brand-wrapper"><span>Akka-DDD</span></div></a></li>  <li><a href="/akka-ddd/docs/aggregate-root.html" class="">Aggregate Root</a> <ul class="sub_section"> <li><a href="/akka-ddd/docs/aggregate-root/logical-model" class="">Logical Model</a></li> <li><a href="/akka-ddd/docs/aggregate-root/implementation" class="">Implementation</a></li> <li><a href="/akka-ddd/docs/aggregate-root/actor" class="">Actor</a></li> <li><a href="/akka-ddd/docs/aggregate-root/configuration" class="">Configuration</a></li> <li><a href="/akka-ddd/docs/aggregate-root/testing" class="">Testing</a></li></ul></li> <li><a href="/akka-ddd/docs/process-manager.html" class="">Process Manager</a> <ul class="sub_section"> <li><a href="/akka-ddd/docs/process-manager/intro" class="">Introduction</a></li> <li><a href="/akka-ddd/docs/process-manager/impl" class="">Implementation</a></li> <li><a href="/akka-ddd/docs/process-manager/saga-pattern" class="">Saga Pattern</a></li> <li><a href="/akka-ddd/docs/process-manager/configuration" class="">Configuration</a></li> <li><a href="/akka-ddd/docs/process-manager/testing" class="">Testing</a></li></ul></li> <li><a href="/akka-ddd/docs/projections.html" class="">Projections</a></li> <li><a href="/akka-ddd/docs/reliable-messaging.html" class=" active ">Reliable messaging</a></li></ul></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li id="gh-eyes-item" class="hidden-xs"><a href="https://github.com/pawelkaczor/akka-ddd"><i class="fa fa-eye"></i><span>WATCH<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs"><a href="https://github.com/pawelkaczor/akka-ddd"><i class="fa fa-star-o"></i><span>STARS<span id="stars" class="label label-default">--</span></span></a></li><li><a href="#" onclick="shareSiteTwitter('Akka-DDD Scala CQRS/ES framework');"><i class="fa fa-twitter"></i></a></li><li><a href="#" onclick="shareSiteFacebook('Akka-DDD Scala CQRS/ES framework');"><i class="fa fa-facebook"></i></a></li><li><a href="#" onclick="shareSiteGoogle();"><i class="fa fa-google-plus"></i></a></li></ul></div></div></div></div><div id="content" data-github-owner="pawelkaczor" data-github-repo="akka-ddd"><div class="content-wrapper"><section><h2 id="reliable-delivery">Reliable delivery</h2>

<p>By reliable delivery I mean effectively-once delivery, which takes place when:</p>

<ul>
  <li>message is delivered <strong>at least once</strong>,</li>
  <li>message is processed (by the destination actor) <strong>exactly-once</strong>,</li>
  <li>messages are processed (by the destination actor) in the order they were dispatched for delivery by the sender.</li>
</ul>

<p>Effectively-once delivery (a.k.a. The Business Handshake Pattern) can easily be accomplished if the sender keeps track of the “in delivery” messages and the receiver keeps track of the processed messages. The implementation of the pattern becomes straightforward if both the sender and the receiver are event-sourced actors.</p>

<h2 id="reliable-messaging-between-event-sourced-actors">Reliable messaging between event-sourced actors</h2>

<p>To support the <code class="highlighter-rouge">At-Least-Once</code> delivery semantics (which is the ground for the reliable delivery) the sender should mix in the <a href="https://github.com/akka/akka/blob/master/akka-persistence/src/main/scala/akka/persistence/AtLeastOnceDelivery.scala">AtLeastOnceDelivery</a> trait.</p>

<p>The <code class="highlighter-rouge">At-Least-Once</code> delivery implies that the original message send <strong>order is not always retained</strong> and the destination may receive <strong>duplicate messages</strong> due to possible resends.</p>

<h3 id="deduplication">Deduplication</h3>

<p>As long as the actions, that the receiver takes to process the messages, are <strong>idempotent</strong>, the duplicate messages are not a problem. 
Otherwise the receiver should obtain the identifier of the received message and attach it to the event message (as a <code class="highlighter-rouge">CausationID</code> meta-attribute) that gets written to the receiver journal. The receiver should recognize an incoming message as a duplicate by checking if its ID is one of those IDs collected in the past. Obviously, the detected duplicate message should not be processed by the receiver. Still, the acknowledgment (delivery receipt) should be sent to the sender.</p>

<p>Akka-DDD provides the <a href="https://github.com/pawelkaczor/akka-ddd/blob/master/akka-ddd-core/src/main/scala/pl/newicom/dddd/messaging/Deduplication.scala">Deduplication</a> trait that implements the logic of the deduplication as described above. The trait is mixed in by the <a href="https://github.com/pawelkaczor/akka-ddd/blob/master/akka-ddd-core/src/main/scala/pl/newicom/dddd/aggregate/AggregateRootBase.scala">AggregateRootBase</a> and the <a href="https://github.com/pawelkaczor/akka-ddd/blob/master/akka-ddd-core/src/main/scala/pl/newicom/dddd/process/SagaBase.scala">SagaBase</a> traits.</p>

<hr />
<p>Akka-DDD guarantees that a message is not processed twice by an Aggregate Root or a Process Manager.</p>

<hr />

<h3 id="processing-messages-in-proper-order">Processing messages in proper order</h3>

<p>Messages should be processed by the receiver in order they were dispatched for delivery by the sender.</p>

<p>The sender should maintain the <code class="highlighter-rouge">lastSentMsgIdPerReceiver</code> map (of type: Map[EntityId, String]) as part of its <a href="https://github.com/pawelkaczor/akka-ddd/blob/master/akka-ddd-messaging/src/main/scala/pl/newicom/dddd/delivery/DeliveryState.scala#L61">DeliveryInProgressState</a>. Using this map, when sending a message to a receiver, the sender should obtain the ID of the last message that was sent to the receiver, and attach it to the message being sent as the <code class="highlighter-rouge">MustFollow</code> meta-attribute. Assuming, the receiver knows the IDs of the messages received/processed in the past (see: Deduplication), it should recognize an incoming message as an out-of-order, if no message was received/processed in the past whose ID was equal to the value of the <code class="highlighter-rouge">MustFollow</code> meta-attribute of the incoming message.</p>

<hr />
<p>Akka-DDD guarantees that the Process Manager processes the events in the order they were written to the aggregated business process journal.</p>

<hr />

<h4 id="process-manager--aggregate-root">Process Manager ⟶ Aggregate Root</h4>

<p>Currently, the <code class="highlighter-rouge">MustFollow</code> meta-attribute is not attached automatically by the Process Managers to the outgoing messages (commands). Thus, when designing a business process logic, in order to avoid out-of-order commands on the receiver side, care must be taken not to define state transitions with an action to send multiple commands to the same Aggregate Root. Instead, intermediary states should be introduced to the process model.</p>
</section></div></div></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/akka-ddd/highlight/highlight.pack.js"></script><script>hljs.configure({
languages:['scala','java','bash']
});
hljs.initHighlighting();
             </script><script>((window.gitter = {}).chat = {}).options = {
room: 'pawelkaczor/akka-ddd'};</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js"></script><script src="/akka-ddd/js/main.js"></script></body></html>